---
title: "Entregable_R4"
author: "Andres R, Alejandro Tomé, David López"
date: "2024-11-06"
output:
  html_document:
    df_print: paged
---

# Análisis Exploratorio del Conjunto de Datos (Bank0_train)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/David Lopez/Desktop/Estadistica/Datos y Código-20241023")

library(knitr)
library(ggplot2)
library(ggmosaic)
```

## **Carga de los datos**

```{r}

datos <- read.table('bank0_train.txt',header=TRUE,sep=';',stringsAsFactors = TRUE)
```

```{r}
View(datos)
```

Identificación de variables categóricas y numéricas

```{r}

var.clss <- sapply(datos,class)
var.cat <- which(var.clss=="factor" & names(datos)!="y")
var.num <- which(var.clss %in% c("numeric","integer"))
```

## **Resumen de los datos**

1.  **Resumen de variables categóricas**

    ```{r}

    for (var in names(var.cat)) {
      print(kable(
        summary(datos[, c(var)]), 
        caption = paste("Resumen de la variable ", var),
        col.names = c('Categoría', 'Frecuencia')))
    }
    ```

<!-- -->

2.  **Resumen de variables numéricas**

    ```{r}

    for (var in names(var.num)) {
      sum <- summary(datos[, c(var)])
      p.names <- names(sum)
      vals <- as.numeric(sum)
      names(vals) <- p.names
      print(kable(
        vals, 
        caption = paste("Resumen de la variable ", var),
        col.names = c("Estimador", "Valor")))
    }
    ```

3.  **Análisis de la variable objetivo**

    ```{r}

    ggplot(as.data.frame(table(datos$y)), aes(x = Var1, y = Freq, fill = factor(Var1))) +
      geom_bar(stat = "identity") +
      scale_fill_manual(values = c("yes" = "blue", "no" = "salmon")) +
      labs(x = "Categorías", y = "Frecuencias", fill = "Categorías") +
      theme_minimal()
    ```

    Puede observarse que existe un grado de desbalanceo entre los registros para casos que si se devolvió el préstamo con respecto a aquellos que no.

## **Análisis de variables de entrada**

1.  **Análisis de sesgo en el origen de los clientes**

    -   **Interpretación del gráfico**

        El gráfico muestra la proporción entre los clientes nacionales y aquellos de procedencia extranjera

        ```{r}
        ggplot(as.data.frame(table(datos$foreign)), aes(x = Var1, y = Freq, fill = factor(Var1))) +
          geom_bar(stat = "identity") +
          scale_fill_manual(values = c("yes" = "blue", "no" = "salmon")) +
          labs(x = "Categorías", y = "Frecuencias", fill = "Categorías") +
          theme_minimal()
        ```

        El desbalance resulta en más de un 95% de los registros representando clientes de procedencia extranjera. Si además se observa la relación entre esta variable y la variable objetivo:

        ```{r}

        ggplot(data = datos) +
          geom_mosaic(aes(weight = 1, x = product(foreign), fill = y)) +
          scale_fill_manual(values = c("yes" = "blue", "no" = "salmon")) +
          labs(x = "Extranjero", y = "Frecuencia", fill = "Cumple Crédito") +
          theme_minimal() +
          ggtitle("Mosaic Plot of Foreign vs Y")
        ```

    -   **Interpretación de los resultados**

        La proporción observada a priori de mayor cantidad de clientes de origen nacional que cumplen el crédito con respecto a los extranjeros no puede tenerse en cuenta debido a la proporción notoriamente menor de los primeros. Esta variable no debería ser tomada en cuenta al analizar las causas de incumplimiento de créditos

2.  **Distribución de Edades según el Cumplimiento de Pago de Crédito**

    -   **Interpretación del gráfico**

        El gráfico muestra la distribución de personas según su grupo de edad y su comportamiento con respecto al pago del crédito. Los grupos de edad se dividen en intervalos de 10 años, desde 18 hasta más de 55 años, y se clasifican a las personas en dos categorías: quienes cumplieron con el pago de crédito ("Sí") y quienes no lo hicieron ("No").

        ```{r}

        datos$age.group <- cut(
          datos$age, 
          breaks = c(0, 25, 35, 45, 55, 100), 
          labels = c("Joven", "Adulto Joven", "Adulto", "Mediana Edad", "Mayor"))

        ggplot(datos, aes(x = age.group, fill = y)) +
          geom_bar(position = "dodge") +
          labs(
            title = "Distribución de Edades según el Pago de Crédito",
            x = "Grupo de Edad",
            y = "Cantidad de Personas",
            fill = "Pago de Crédito"
          ) +
          scale_x_discrete(labels = c("18-25", "26-35", "36-45", "46-55", "56+")) +
          scale_fill_manual(values = c("yes" = "blue", "no" = "salmon")) +
          theme_minimal()
        ```

    -   **Interpretación los Resultados**:

        1.  **Grupo de 18-25 años**:

            Presenta un balance más cercano entre quienes cumplieron y no cumplieron con el pago. Esto indica un comportamiento financiero más incierto entre los clientes en el rango de edad.

        2.  **Grupo de 26-35 años**:

            Es el grupo con la mayor cantidad de personas, las cuales presentan una proporción significativa de cumplimiento de pago del crédito.

        3.  **Grupos con mayores de 35 años**:

            La proporción de personas que cumplen o no con el crédito parece tener un comportamiento similar a aquel del grupo mayoritario. El aumento del grupo de edad trae una disminución de la cantidad de clientes con crédito contratado, aunque la inspección gráfica indica que la proporción se mantiene similar

        4.  **Test de diferencia de proporciones**

            Se realiza un grupo de tests de proporción entre los grupos de edad definidos, con un intervalo de confianza del 95%.

            ```{r}

            cont.table <- table(datos$age.group, datos$y)
            age.levels <- levels(factor(datos$age.group))

            no.count <- cont.table[, 'no']
            count.tots <- rowSums(cont.table)

            results <- data.frame(
              test = character(),
              conf.int = character(),
              p.value = numeric(),
              stringsAsFactors = FALSE
            )

            for (i in 1:(length(age.levels) - 1)) {
              for (j in (i + 1):length((age.levels))) {
                 pair <- c(age.levels[i], age.levels[j])
                 counts <- no.count[pair]
                 totals <- count.tots[pair]
                 
                 result <- prop.test(counts, totals)
                 
                 int <- paste0(
                   "(", 
                   round(result$conf.int[1], 3), 
                   ", ", 
                   round(result$conf.int[2], 3), ")"
                 )
                
                # Add results to data frame
                results <- rbind(results, data.frame(
                  test = paste(pair, collapse = " vs "),
                  conf.int = int,
                  p.value = round(result$p.value, 3)
                ))
              }
            }

            kable(
              results, 
              caption = "Resultados de test de proporciones", 
              col.names = c('Prueba', 'Intervalo de confianza', "p-Valor"))
            ```

            Primeramente se observa que el p-valor para todos los casos que implican al grupo "Joven" se encuentra por debajo del umbral definido (0.05 para un 95% de confianza), que confirma la conclusión obtenida del análisis gráfico. De igual manera, los tests entre el resto de grupos supera el umbral, por lo que en consecuencia no se pueden determinar diferencias significativas entre la proporción de personas que no cumple el crédito entre los grupos de edad. Esto es acorde con la hipótesis planeada por inspección gráfica

3.  **Análisis del Proposito de Credito según su Estado de Pago:**

    -   **Interpretación del Gráfico**:

        En el grafico se evidencia la proporción del crédito en relación con el estado de pago (Yes or No). Este análisis proporciona una visión general del comportamiento de pago según el objetivo del crédito en especifico, lo cual permite identificar las diferencias entre las distintas categoras.

        ```{r}
        ggplot(datos, aes(x = purpose, fill = y)) +
          geom_bar(position = "fill") +  # Proporciones relativas
          labs(
            title = "Distribución del Propósito del Crédito según Estado de Pago",
            x = "Propósito del Crédito",
            y = "Proporción",
            fill = "Estado de Pago"
          ) +
          theme_minimal() +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))
        ```

    -   **Interpretación de los Resultados**:

        -   **Proporciones Altas de Cumplimiento:**

            1.  Aquellos resultados con mayor proporción de créditos cumplidos no muestran una relación apreciable según su tipo.

            2.  Aunque sugieran elevada proporción de pagos yes (Sí), las categorías por si solas no pueden indicar el nivel de certeza en que se va a cumplir un crédito.

        -   **Proporciones Altas de Incumplimiento:**

            1.  Los propositos repairs y education presentan una proporción más alta del incumplimiento de los créditos en comparación con otros propósitos.

            2.  Se considera que la educación podría guardar relación con la edad de los clientes, debido a ser más comunes los préstamos para estudios de alto coste, como grados. Sin embargo, la distribución de cumplimiento de los créditos para educación demuestra lo contrario

                ```{r}

                filtered_data <- datos[datos$purpose == 'education', ]

                ggplot(filtered_data, aes(x = age, fill = y)) +
                  geom_histogram(bins = 10, position = position_dodge(width = 2.5), color = "black") +
                  labs(title = "Histogram of Age for Education Purpose by Response",
                       x = "Age",
                       y = "Count",
                       fill = "Response") +
                  theme_minimal()
                ```

4.  **Análisis del Número de Créditos Activos según Estado de Pago:**

    -   **Interpretación del Gráfico**:

        El grafico muestra la relación entre el número de créditos activos con respecto al estado de pago (Yes para los clientes que pagaron y No para los que no lo hicieron). A traves de este análisis podremos observar e identificar cómo la cantidad créditos activos de un cliente puede afectar la probabilidad de cumplimientos con los pagos.

        ```{r}
        ggplot(datos, aes(x = as.factor(num.credits), fill = y)) +
          geom_bar(position = "dodge") +
          labs(
            title = "Número de Créditos Activos según Estado de Pago",
            x = "Número de Créditos Activos",
            y = "Cantidad",
            fill = "Estado de Pago"
          ) +
          theme_minimal()
        ```

    -   **Interpretación de los Resultados**:

        Se observa una disminución paulativa (esperable) de la cantidad de clientes con créditos contratados según los últimos aumentan. Sin embargo, con respecto a la influencia de esto en el cumplimiento con el crédito, el análisis gráfico arroja que las proporciones de cumplimiento o no se mantienen uniformes entre las cantidades de créditos activos

        -   Test de diferencia de proporciones

            Se retoma el enfoque utilizado en las proporciones de cumplimientos entre grupos de edades: test estadísticos con un intervalo de confianza del 95% entre cada posibilidad. Debido a la poca cantidad de datos disponibles para los clientes con más de 2 créditos, estos son omitidos.

            ```{r}

            cont.table <- table(as.factor(datos$num.credits), datos$y)

            pair <- c('1', '2')

            no.count <- cont.table[, 'no']
            count.tots <- rowSums(cont.table)

            result <- prop.test(no.count[pair], count.tots[pair])

            results <- data.frame(
              test = paste(paste(pair, collapse = " credit vs "), " credits"),
              conf.int = paste0(
                 "(", 
                 round(result$conf.int[1], 3), 
                 ", ", 
                 round(result$conf.int[2], 3), ")"),
                p.value = round(result$p.value, 3),
                stringsAsFactors = FALSE
            )


            kable(
              results, 
              caption = "Resultados de test de proporciones", 
              col.names = c('Prueba', 'Intervalo de confianza', "p-Valor"))
            ```

            El resultado del p-valor supera el umbral definido (0.05), por lo que, en corcondancia con la inspección visual, no se puede definir una relación directa entre el número de créditos activo y el cumplimiento del estudiado
```{r}

```

##1.2 **Modelo de regresion logistica**

```{r}
##--Densidad para las variables numericas
var.num <- which(sapply(datos,class) %in% c("numeric","integer"))    # variables que son numericas
for(vn in var.num) cdplot(datos$y~datos[,vn],main=names(datos)[vn],n=512)
```
```{r}

```

# **Se oberva que para el grafico credit.amo la relacion que se tiene es que los clientes con montos de creditos más bajos tienden a pagar y los que tienen creditos más grande no.**
```{r}
# Establecer categorias de referencia en variables categoricas
  ############################################################
  ##-- La instruccion relevel cambia la categoria de referencia en las variables categoricas
  ##-- Se escoge la referencia no por criterios estadisticos, sino de interpretabilidad
  datos$status <- relevel(datos$status,ref="no checking account")
  datos$credit.hist <- relevel(datos$credit.hist,ref="no credits taken/all credits paid back duly")
  datos$purpose <- relevel(datos$purpose,ref="others")
  datos$savings <- relevel(datos$savings,ref="unknown/no savings account")
  datos$employed.time <- relevel(datos$employed.time,ref="unemployed")
  datos$status.sex <- relevel(datos$status.sex,ref="male:single")
  datos$debtors <- relevel(datos$debtors,ref="none")
  datos$property <- relevel(datos$property,ref="unknown/no property")
  datos$installment2 <- relevel(datos$installment2,ref="none")
  datos$housing <- relevel(datos$housing,ref="for free")
  datos$job <- relevel(datos$job,ref="unskilled - resident")
  datos$telephone <- relevel(datos$telephone,ref="none")
  datos$foreign <- relevel(datos$foreign,ref="no")

```
# **La categoria para cada variable se asigna en opcion de lo que se considera la mas interpretable o relevate para el analisis**


```{r}
##-- Modelo completo
mod.glm0 <- glm(y~.,datos,family=binomial)    # estimacion del modelo
summary(mod.glm0) 

```
```{r}

```

## **Podemos extraer que:
variables como -duration,purposecar, credit.amo entre otras tienen un nivel de significancia de p<0,05 lo cual nos indica que hay suficiente evidencia para rechazar la hipotesis nula y concluir que estas variables tienen un efecto significativo sobre el modelo**
```{r}
##-- Missings 
apply(apply(datos,2,is.na),2,sum)             # cuantos missings tiene cada variable --> Step no se puede aplicar con missings
```
```{r}
##-- Funcion step (requiere que no haya missings si ha de quitar una variable que tenga)
mod.glm1 <- step(mod.glm0)
summary(mod.glm1)
```
```{r}

```
```{r}
##-- Importancia de las categorias/covariables segun su significacion estadistica
install.packages('caret')
library(caret)
View(varImp(mod.glm1))
```
```{r}
##-- Por inspeccion visual
br <- quantile(fitted(mod.glm1),seq(0,1,0.1))                                # Se crean los puntos de corte para los intervalos (br) de las probabilidades predichas
int <- cut(fitted(mod.glm1),br)                                              # Se crea una variable con el intervalo al que pertenece cada individuo
obs <- tapply(mod.glm1$y,int,sum)                                            # Los pagos observados en cada intervalo
exp <- tapply(fitted(mod.glm1),int,sum)                                      # Los pagos esperados en cada intervalo  
plot(1:10+0.05,exp,type='h',xlab="Intervalos",ylab="Frecuencias",lwd=2)      # Grafico de los pagos esperados
lines(1:10-0.05,obs,type='h',col=2,lwd=2)                                    # Se anyade los pagos observados
legend("topleft",c("Pagan - esperados", "Pagan - observados"),lwd=2,col=1:2) # Se anyade una leyenda

```
```{r}
##**En la mayoría de los intervalos, las frecuencias observadas y las esperadas (líneas rojas) son muy cercanas en sus valores. Dadas las circunstancias podemos inferir que, en general, el modelo ha tenido un buen rendimiento al momento de predecir los eventos dentro de los intervalos de pago. Sin embargo, la proximidad de las líneas revela que, al mismo tiempo, el modelo comete errores y debe evaluar mejor muchos pagos.**
```
```{r}
##--test de Hosmer-Lemeshow
install.packages('ResourceSelection')
library(ResourceSelection)
hoslem.test(mod.glm1$y, fitted(mod.glm1))  # si el p-valor es inferior a 0.05 quedaria en duda el modelo                              

```
##** el pvalor de 0.75 nos indica que el modelo se ajusta bien a los datos observados,no hay discrepancia entre las frecuencias observadas y las esperadas**
```{r}
# Estimacion de un Odds Ratio
############################################################
##-- Variable categorica
exp(mod.glm1$coef["foreignyes"])    # Los extranjeros tienen un oddsratio de 0.17 respecto a los no extranjeros. Es decir, las probabilidades de pagar son un 0.17 la de los nacionales 

##-- Variable numerica
exp(mod.glm1$coef["age"])           # Por cada anyo de mas de la persona se incrementa en un 2% (aprox) la probabilidad de que acabe pagando

##--Intervalos de confianza
IC <- confint(mod.glm1)             # Intervalos de  confianza para los coeficientes
round(exp(IC),2)                    # Intervalos de confianza para los ORs redondeados a 2 decimales

```


```{r}
#**al parecer, ser extranjero está fuertemente asociado con una menor probabilidad de pago, mientras que la edad tiene un efecto positivo, pero leve, en la probabilidad de cumplir con el pago.**
```

```{r}
pr <- predict(mod.glm1,datos,type="response")
pr

##--Probabilidad maxima y minima
pos.max <- which.max(pr)        # posicion del individuo con mayor probabilidad de pagar
pr[pos.max]                     # probabilidad de dicho individuo 
datos$y[pos.max]                # pago?

pos.min <- which.min(pr)        # posicion del individuo con menor probabilidad de pagar
pr[pos.min]                     # probabilidad de dicho individuo 
datos$y[pos.min]                # pago?

boxplot(pr~y,datos)
```

```{r}
##**en conclusion, clientes que pagaron tienen una probabilidad de pago más alta, con densidad concentrada alrededor de 0.8 en adelante. Asimismo, los clientes que no pagaron, poseen una baja probabilidad de pago, con una mediana de alrededor 0.4. En pocas palabras, podemos decir que el modelo puede distinguir claramente a los dos grupos de personas con respecto a la probabilidad de pago, lo que implica un buen rendimiento predictivo.**
```

```{r}
# Curva ROC y AUC
############################################################
Instalar libreria AUC
install.packages('AUC')
library(AUC)

##-- Curva ROC y AUC
pr <- predict(mod.glm1,type='response')
roc.curve <- roc(pr,datos$y)
plot(roc.curve)
AUC::auc(roc.curve)
```

```{r}
#**El área bajo la curva (AUC) es de 0.836, esto muestra un rendimiento decente del modelo al intentar predecir la diferencia entre las clases. Un AUC que está más cerca del 1 muestra que el modelo tiene una buena capacidad de clasificar correctamente. Aunque este modelo sea igualmente efectivo con un AUC de 0.836, aún no es perfecto.**
```

```{r}
# Calibracion del modelo
############################################################
install.packages('PresenceAbsence')
library(PresenceAbsence)
df.calibra <- data.frame(plotID=1:nrow(datos), Observed = as.numeric(datos$y)-1  , Predicted1 = pr)
calibration.plot(df.calibra, N.bins = 10,ylab='Observed probabilities')
detach('package:PresenceAbsence')
```

```{r}
##**La proximidad de los puntos a la línea diagonal indica que el modelo está bien calibrado:las probabilidades predichas se alinean con las observadas sin ser sistemáticamente altas o bajas. Esto muestra que el modelo no solo discrimina bien entre pagadores y no pagadores, sino que también asigna probabilidades precisas,lo cual es clave para una evaluación confiable del riesgo**
```

```{r}
test <- read.table('bank0_test.txt',header=TRUE,sep=';', stringsAsFactors = TRUE)

############################################################
# Calcular predicciones y compararlas con valores reales
############################################################
pr <- predict(mod.glm1,test)   # probabilidades predichas
boxplot(pr~test$y)
```

En comparacion con el modelo anterior la separacion entre los pagadores y no pagadores era más clara, con los que pagaron mostrando prabilidades mayores, en este de prueba aunque se ve la diferencia es menos  marcada.

```{r}
# Como son estas probabilidades en ambos grupos de respuesta
roc.curve <- roc(pr,test$y)    # Calculo de la curva ROC
plot(roc.curve)                # Dibujo de la curva ROC
```
```{r}
AUC::auc(roc.curve)                 # AUC de la curva ROC
```
El modelo aun muestra una buena discriminacion, es menor que al de train pero es notorio, esto puede indicar que el modelo no generaliza bien los datos, esto es un factor a mejorar.


```{r}
##-- Sensibilidad y especificidad para un punto de corte concreto
s <- AUC::sensitivity(pr,test$y)
e <- AUC::specificity(pr,test$y)
a <- AUC::accuracy(pr,test$y)
df <- data.frame(cutpoints=s$cutoffs,sens=s$measure,esp=e$measure,acc=a$measure)
View(round(df,3))

##-- Escoger un punto de corte --> Matriz de confusion
test$doy.credito <- ifelse(pr>0.5,'si','no')  # Doy credito a aquellos con un probabilidad predicha de pagar superior a 0.5
with(test,table(doy.credito,y))
with(test,round(100*prop.table(table(doy.credito,y),1),1))
```
```{r}
#No Crédito (doy.credito-no)
#correctamente clasificados como no (no pagarán): 45.9%
#incorrectamente clasificados como no (pero sí pagarían): 54.1%
#otorga crédito (doy.credito-si)
#correctamente clasificados como sí (pagarán): 82.7%
#incorrectamente clasificados como sí (pero no pagarían): 17.3%

#**El modelo en el conjunto de prueba sigue teniendo efectividad para identificar a los pagadores, lo cual es bueno, pero tiene problemas al identificar a los que no pagaran** 
```
